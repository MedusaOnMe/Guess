<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude GeoGuessr AI Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #0f0f0f 100%);
            color: #f5f5f5;
            overflow-x: hidden;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3.2em;
            margin-bottom: 10px;
            font-weight: 400;
            letter-spacing: -0.02em;
            color: #C15F3C;
            text-shadow: none;
        }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.8;
            font-weight: 300;
            color: #cccccc;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .image-panel {
            background: rgba(25, 25, 25, 0.8);
            border-radius: 12px;
            padding: 30px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(193, 95, 60, 0.2);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 500px;
        }

        .status-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .status-header h2 {
            color: #C15F3C;
            font-weight: 300;
            font-size: 1.4em;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-indicator.idle { background: #666666; }
        .status-indicator.thinking { background: #C15F3C; }
        .status-indicator.processing { background: #D4723F; }
        .status-indicator.completed { background: #6B9B37; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .current-task {
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 300;
            color: #f5f5f5;
            line-height: 1.4;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #C15F3C, #D4723F);
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
        }

        .thinking-dots {
            font-size: 2em;
            text-align: center;
            margin: 20px 0;
        }

        .thinking-dots::after {
            content: '...';
            animation: thinking 1.5s infinite;
        }

        @keyframes thinking {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .streetview-container {
            text-align: center;
            margin: 20px 0;
        }

        .streetview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 12px 48px rgba(0,0,0,0.4);
            border: 1px solid rgba(193, 95, 60, 0.3);
            transition: all 0.3s ease;
        }

        .terminal {
            padding: 0;
            margin: 20px 0;
            font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', Monaco, Consolas, monospace;
            font-size: 0.9em;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            color: #e0e0e0;
        }
        
        .thinking-text {
            background: rgba(193, 95, 60, 0.1);
            border-left: 3px solid #C15F3C;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.95em;
            line-height: 1.5;
            color: #f0f0f0;
        }
        
        .typewriter {
            border-right: 2px solid #C15F3C;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { border-color: transparent; }
        }

        .results-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .results-content {
            background: rgba(25, 25, 25, 0.95);
            border: 2px solid #C15F3C;
            border-radius: 15px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            backdrop-filter: blur(20px);
        }
        
        .results-header {
            color: #C15F3C;
            font-weight: bold;
            font-size: 1.8em;
            margin-bottom: 30px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .result-card {
            background: rgba(193, 95, 60, 0.1);
            border: 1px solid rgba(193, 95, 60, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .result-card.highlight {
            background: rgba(193, 95, 60, 0.2);
            border: 2px solid #C15F3C;
        }
        
        .result-title {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .result-value {
            font-weight: 600;
            font-family: 'SF Mono', Monaco, Consolas, monospace;
            font-size: 1.1em;
        }
        
        .result-value.score {
            color: #C15F3C;
            font-size: 2em;
            font-weight: bold;
        }
        
        .terminal-header {
            color: #C15F3C;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .terminal-line {
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .terminal-prompt {
            color: #C15F3C;
            font-weight: 600;
        }

        .image-placeholder {
            width: 100%;
            height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(193, 95, 60, 0.8);
            font-size: 1.1em;
            text-align: center;
        }

        .thoughts-panel {
            background: rgba(25, 25, 25, 0.8);
            border-radius: 12px;
            padding: 30px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(193, 95, 60, 0.2);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.3);
            max-height: 500px;
            overflow-y: auto;
        }
        
        .thoughts-header {
            color: #C15F3C;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 18px;
            border: 1px solid rgba(193, 95, 60, 0.15);
            transition: all 0.2s ease;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 5px;
            color: #C15F3C;
        }

        .stat-label {
            font-size: 0.8em;
            opacity: 0.8;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recent-guesses {
            margin-top: 20px;
        }

        .guess-item {
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 2px solid rgba(193, 95, 60, 0.4);
            transition: all 0.2s ease;
        }

        .guess-location {
            font-weight: 600;
        }

        .guess-score {
            background: linear-gradient(45deg, #C15F3C, #D4723F);
            border-radius: 12px;
            padding: 6px 14px;
            font-size: 0.85em;
            font-weight: 400;
            color: white;
            font-family: 'SF Mono', Monaco, Consolas, monospace;
        }

        .queue-status {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(193, 95, 60, 0.2);
            border-radius: 8px;
            padding: 18px;
            margin-top: 24px;
            text-align: center;
        }

        .queue-count {
            font-size: 1.4em;
            font-weight: 300;
            color: #C15F3C;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            opacity: 0.6;
            font-size: 0.85em;
            font-weight: 300;
            color: #999999;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ClaudeGuessr</h1>
            <div class="subtitle">Autonomous AI powered by Claude analyzing Street View imagery and making geographic predictions</div>
        </div>

        <div class="main-grid">
            <div class="image-panel">
                <img class="streetview-image" id="streetviewImage" src="" alt="Street View" style="display: none;">
                <div class="image-placeholder" id="imagePlaceholder">
                    <div>Ready for geographic analysis</div>
                    <div style="font-size: 0.9em; opacity: 0.7; margin-top: 12px;">Submit a location via Twitch chat</div>
                </div>
            </div>

            <div class="thoughts-panel">
                <div class="thoughts-header">Claude's Mind</div>
                <div id="terminalContent"></div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="results-overlay" id="resultsOverlay" style="display: none;">
            <div class="results-content">
                <div class="results-header">Analysis Complete</div>
                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-title">Claude's Guess</div>
                        <div class="result-value" id="predictionCoords">--</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">Actual Location</div>
                        <div class="result-value" id="actualLocation">--</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">Distance Off</div>
                        <div class="result-value" id="distanceOff">--</div>
                    </div>
                    <div class="result-card highlight">
                        <div class="result-title">Score</div>
                        <div class="result-value score" id="finalScore">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-grid" style="margin-top: 30px;">
            <div class="stat-item">
                <div class="stat-value" id="totalGuesses">0</div>
                <div class="stat-label">Total Predictions</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="averageScore">0</div>
                <div class="stat-label">Avg Score</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="bestScore">0</div>
                <div class="stat-label">Best Score</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastScore">0</div>
                <div class="stat-label">Last Score</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="queueCount">0</div>
                <div class="stat-label">Queue Status</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="accuracy">--</div>
                <div class="stat-label">Avg Distance</div>
            </div>
        </div>

        <div class="footer">
            <p>Powered by Claude AI Vision â€¢ Autonomous Geographic Intelligence System</p>
        </div>
    </div>

    <script>
        let currentStatus = 'idle';

        async function updateDashboard() {
            try {
                console.log('Fetching data...');
                
                // Fetch agent status
                const statusResponse = await fetch('agent_status.json');
                console.log('Status response:', statusResponse.status);
                const status = await statusResponse.json();
                console.log('Status data:', status);
                
                // Fetch results data
                const resultsResponse = await fetch('results.json');
                console.log('Results response:', resultsResponse.status);
                const results = await resultsResponse.json();
                console.log('Results data:', results);

                updateAgentStatus(status);
                updateStatistics(results);
                
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('currentStatus').textContent = 'Error: ' + error.message;
            }
        }

        let lastStatus = null;
        let imageLoaded = false;

        function updateAgentStatus(status) {
            const terminalContent = document.getElementById('terminalContent');
            const streetviewImage = document.getElementById('streetviewImage');
            const imagePlaceholder = document.getElementById('imagePlaceholder');

            // Only add to terminal if status actually changed (skip routine status updates)
            if (!lastStatus || 
                (status.step !== 'idle' && status.step !== 'thinking' && (lastStatus.step !== status.step || lastStatus.message !== status.message)) ||
                (status.data && status.data.analysis && (!lastStatus.data || !lastStatus.data.analysis))) {
                
                // Only log meaningful state changes
                if (status.step === 'processing' && status.message.includes('Processing location request')) {
                    addTerminalLine({step: 'start', message: `New challenge: ${status.data.current_location}`});
                }
            }

            // No progress bar needed - pure thoughts only

            // Show street view image if available or if we've already loaded one for this session
            if ((status.data && status.data.showing_image) || 
                (status.step === 'processing' && status.message.includes('Street View image successfully acquired')) ||
                (status.step === 'processing' && status.message.includes('Visual analysis') && !imageLoaded) ||
                (status.step === 'thinking' && imageLoaded)) {
                
                if (!imageLoaded || status.data.showing_image || status.message.includes('Visual analysis')) {
                    streetviewImage.src = 'current.png?' + new Date().getTime();
                    imageLoaded = true;
                }
                streetviewImage.style.display = 'block';
                imagePlaceholder.style.display = 'none';
            } else if (status.step === 'processing' && status.message.includes('Processing location request')) {
                // New request started - reset image state
                imageLoaded = false;
                streetviewImage.style.display = 'none';
                imagePlaceholder.style.display = 'flex';
                imagePlaceholder.innerHTML = '<div>Loading Street View imagery...</div>';
            } else if (status.step === 'idle' && !imageLoaded) {
                // Only hide image if we haven't loaded one yet
                streetviewImage.style.display = 'none';
                imagePlaceholder.style.display = 'flex';
                imagePlaceholder.innerHTML = '<div>Ready for geographic analysis</div><div style=\"font-size: 0.9em; opacity: 0.7; margin-top: 12px;\">Submit a location via Twitch chat</div>';
            }

            // Show Claude's thoughts with typewriter effect
            if (status.data && status.data.analysis && 
                (!lastStatus || !lastStatus.data || lastStatus.data.analysis !== status.data.analysis)) {
                showThinkingText(status.data.analysis, status.data.analysis_type);
            }

            lastStatus = JSON.parse(JSON.stringify(status)); // Deep copy
        }

        function addTerminalLine(status) {
            const terminalContent = document.getElementById('terminalContent');
            const timestamp = new Date().toLocaleTimeString();
            
            let line = `<div class="terminal-line">[${timestamp}] ${status.message}</div>`;
            
            terminalContent.innerHTML += line;
            
            // Auto-scroll to bottom
            const terminal = document.getElementById('terminal');
            terminal.scrollTop = terminal.scrollHeight;
            
            // Keep only last 10 lines
            const lines = terminalContent.querySelectorAll('.terminal-line');
            if (lines.length > 10) {
                lines[0].remove();
            }
        }

        let typingQueue = [];
        let currentlyTyping = false;
        let thoughtCounter = 0;
        let globalThoughtId = 0;
        let coordinatesDisplayed = false;
        
        function showThinkingText(text, analysisType) {
            // Clear previous typing queue if new request started, but don't clear the terminal content
            if (analysisType === 'first') {
                typingQueue = [];
                currentlyTyping = false;
                coordinatesDisplayed = false;
                
                // Clear previous content for new analysis
                const terminalContent = document.getElementById('terminalContent');
                terminalContent.innerHTML = '';
                
                thoughtCounter = 0;
            }
            
            typingQueue.push({text, analysisType});
            if (!currentlyTyping) {
                processTypingQueue();
            }
        }
        
        function processTypingQueue() {
            if (typingQueue.length === 0) {
                currentlyTyping = false;
                // Check for pending coordinates after all typing is done
                setTimeout(() => checkForPendingCoordinates(), 500);
                return;
            }
            
            // Prevent multiple simultaneous typing sessions
            if (currentlyTyping) {
                return;
            }
            
            currentlyTyping = true;
            const {text, analysisType} = typingQueue.shift();
            thoughtCounter++;
            
            const terminalContent = document.getElementById('terminalContent');
            
            // Create thinking container with unique ID
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'thinking-text';
            globalThoughtId++;
            const thoughtId = `thought_${globalThoughtId}`;
            thinkingDiv.innerHTML = `<div class="typewriter" id="${thoughtId}"></div>`;
            
            terminalContent.appendChild(thinkingDiv);
            
            // Typewriter effect
            const thoughtElement = document.getElementById(thoughtId);
            let currentIndex = 0;
            
            function typeNextChar() {
                if (currentIndex < text.length) {
                    thoughtElement.textContent += text[currentIndex];
                    currentIndex++;
                    
                    // Variable typing speed - faster for spaces, slower for punctuation
                    let delay = 12;
                    if (text[currentIndex - 1] === ' ') delay = 8;
                    if (text[currentIndex - 1] === '.' || text[currentIndex - 1] === '!' || text[currentIndex - 1] === '?') delay = 150;
                    if (text[currentIndex - 1] === ',') delay = 80;
                    
                    setTimeout(typeNextChar, delay);
                } else {
                    // Remove cursor when done
                    thoughtElement.classList.remove('typewriter');
                    // Process next item in queue
                    setTimeout(() => processTypingQueue(), 500);
                }
                
                // Auto-scroll to bottom of thoughts panel
                const thoughtsPanel = document.querySelector('.thoughts-panel');
                thoughtsPanel.scrollTop = thoughtsPanel.scrollHeight;
            }
            
            typeNextChar();
            
            // Keep only last 10 thinking blocks total to prevent infinite scroll
            // Only clean up after current typing is done to avoid removing the element we're typing into
            setTimeout(() => {
                const thinkingBlocks = terminalContent.querySelectorAll('.thinking-text');
                if (thinkingBlocks.length > 10) {
                    // Don't remove blocks that are currently being typed into
                    const firstBlock = thinkingBlocks[0];
                    if (!firstBlock.querySelector('.typewriter')) {
                        firstBlock.remove();
                    }
                }
            }, 100);
        }
        
        function checkForPendingCoordinates() {
            // Don't check if we've already displayed coordinates for this round
            if (coordinatesDisplayed) return;
            
            fetch('pending_coordinates.json')
                .then(response => response.json())
                .then(coords => {
                    if (coords && coords.lat && coords.lng && !coordinatesDisplayed) {
                        coordinatesDisplayed = true;
                        
                        // Generate a more human final prediction message
                        const humanPredictions = [
                            `Alright, weighing all the evidence, I'm going to go with these coordinates as my final guess:`,
                            `Based on everything I've analyzed, my best prediction would be:`,
                            `Considering all the clues, I'm settling on these coordinates:`,
                            `After careful consideration, here's where I think we are:`,
                            `Putting it all together, my final assessment points to:`,
                            `Taking everything into account, I believe the location is:`
                        ];
                        
                        const randomPrediction = humanPredictions[Math.floor(Math.random() * humanPredictions.length)];
                        
                        // Create final prediction with typewriter effect
                        let finalPredictionText = randomPrediction + "\n\n";
                        if (coords.pred_place && coords.pred_place !== "Unknown Location") {
                            finalPredictionText += coords.pred_place + "\n" + coords.lat + ", " + coords.lng;
                        } else {
                            finalPredictionText += "Latitude: " + coords.lat + "\nLongitude: " + coords.lng;
                        }
                        
                        // Add to typing queue - let the existing queue system handle it
                        typingQueue.push({text: finalPredictionText, analysisType: 'final'});
                        // Only start processing if nothing is currently typing
                        if (!currentlyTyping) {
                            processTypingQueue();
                        }
                        
                        // Show results panel if we have all data - delay longer since we're typing the prediction
                        if (coords.ready && coords.score !== undefined) {
                            setTimeout(() => showResultsPanel(coords), 3000); // Longer delay to let typing finish
                        }
                    }
                })
                .catch(() => {}); // Ignore if file doesn't exist
        }
        
        function showResultsPanel(coords) {
            const resultsOverlay = document.getElementById('resultsOverlay');
            document.getElementById('predictionCoords').textContent = `${coords.lat}, ${coords.lng}`;
            document.getElementById('actualLocation').textContent = coords.place;  
            document.getElementById('distanceOff').textContent = `${coords.distance.toFixed(1)} km`;
            document.getElementById('finalScore').textContent = coords.score;
            
            resultsOverlay.style.display = 'flex';
            
            // Hide after 5 seconds
            setTimeout(() => {
                resultsOverlay.style.display = 'none';
            }, 5000);
            
            // Also hide on click
            resultsOverlay.onclick = () => {
                resultsOverlay.style.display = 'none';
            };
        }

        function updateStatistics(results) {
            const totalGuesses = results.history ? results.history.length : 0;
            const averageScore = results.total_score && totalGuesses > 0 ? 
                Math.round(results.total_score / totalGuesses) : 0;
                
            // Calculate average distance
            let avgDistance = '--';
            if (results.history && results.history.length > 0) {
                const distances = results.history.filter(h => h.distance_km).map(h => h.distance_km);
                if (distances.length > 0) {
                    avgDistance = (distances.reduce((a, b) => a + b, 0) / distances.length).toFixed(1) + 'km';
                }
            }

            document.getElementById('totalGuesses').textContent = totalGuesses;
            document.getElementById('averageScore').textContent = averageScore;
            document.getElementById('bestScore').textContent = results.best_score || 0;
            document.getElementById('lastScore').textContent = results.last_score || 0;
            document.getElementById('accuracy').textContent = avgDistance;
            
            // Update queue count
            fetch('queue.json')
                .then(response => response.json())
                .then(queue => {
                    document.getElementById('queueCount').textContent = queue.length;
                })
                .catch(() => {
                    document.getElementById('queueCount').textContent = '0';
                });
        }

        // Update dashboard every 1 second
        setInterval(updateDashboard, 1000);
        
        // Initial load
        updateDashboard();
    </script>
</body>
</html>